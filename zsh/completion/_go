#compdef go

local -a commands
commands=(
  'build:compile packages and dependencies'
  'clean:remove object files and cached files'
  'doc:show documentation for package or symbol'
  'env:print Go environment information'
  'fmt:gofmt (reformat) package sources'
  'generate:generate Go files by processing source'
  'get:add dependencies to current module and install them'
  'install:compile and install packages and dependencies'
  'list:list packages or modules'
  'mod:module maintenance'
  'run:compile and run Go program'
  'test:test packages'
  'tool:run specified go tool'
  'version:print Go version'
  'vet:report likely mistakes in packages'
  'work:workspace maintenance'
)

local -a mod_commands
mod_commands=(
  'download:download modules to local cache'
  'edit:edit go.mod from tools or scripts'
  'graph:print module requirement graph'
  'init:initialize new module in current directory'
  'tidy:add missing and remove unused modules'
  'vendor:make vendored copy of dependencies'
  'verify:verify dependencies have expected content'
  'why:explain why packages or modules are needed'
)

local -a work_commands
work_commands=(
  'edit:edit go.work from tools or scripts'
  'init:initialize workspace file'
  'sync:sync workspace build list to modules'
  'use:add modules to workspace file'
)

_go_packages() {
  local -a packages
  packages=($(go list ./... 2>/dev/null))
  _describe -t packages 'packages' packages
}

_go_files() {
  _files -g '*.go'
}

_arguments -C \
  '1:command:->command' \
  '*::arg:->args'

case "$state" in
  command)
    _describe -t commands 'go command' commands
    ;;
  args)
    case "$words[1]" in
      build|install|run|test|vet|fmt)
        _alternative \
          'packages:package:_go_packages' \
          'files:go file:_go_files'
        ;;
      mod)
        _describe -t mod_commands 'mod command' mod_commands
        ;;
      work)
        _describe -t work_commands 'work command' work_commands
        ;;
      get)
        # Could add module path completion here
        ;;
      doc)
        _go_packages
        ;;
    esac
    ;;
esac
